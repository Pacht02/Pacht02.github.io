<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcular Distancias</title>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDIGXKfC3l8btI1dafKYXEITkTRqAA0xyU&libraries=places"
      async defer></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 600px;
            margin: auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .location {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Calcular Distancias</h1>
        <form id="location-form">
            <input type="text" id="coordinates" placeholder="Latitud, Longitud o formato DMS" required>
            <input type="text" id="phone" placeholder="Teléfono del cliente" required>
            <button type="submit">Agregar</button>
        </form>
        <button id="calculate-route">Calcular y Ordenar</button>
        <div id="location-list"></div>
    </div>

    <script>
        let locations = [];

        // Función para convertir coordenadas en formato DMS a decimal
        function convertDMSToDecimal(dms) {
            const regex = /(\d+)[° ]\s*(\d+)[′']?\s*(\d+(\.\d+)?)[″"]?\s*([NSEW])/i;
            const match = dms.match(regex);

            if (!match) return null;

            let degrees = parseFloat(match[1]);
            let minutes = parseFloat(match[2]);
            let seconds = parseFloat(match[3]);
            let direction = match[5].toUpperCase();

            let decimal = degrees + minutes / 60 + seconds / 3600;
            if (direction === "S" || direction === "W") {
                decimal *= -1;
            }

            return decimal;
        }

        // Función para convertir cualquier formato de coordenadas
        function parseCoordinates(input) {
            if (input.includes(",")) {
                // Formato decimal: "19.432608, -99.133209"
                const parts = input.split(",");
                return { lat: parseFloat(parts[0]), lng: parseFloat(parts[1]) };
            } else if (/[°′″]/.test(input)) {
                // Formato DMS
                const [latDMS, lngDMS] = input.split(/\s*,\s*/);
                return {
                    lat: convertDMSToDecimal(latDMS),
                    lng: convertDMSToDecimal(lngDMS),
                };
            } else {
                alert("Formato inválido. Intenta usar decimal o DMS.");
                return null;
            }
        }

        document.getElementById("location-form").addEventListener("submit", (e) => {
            e.preventDefault();

            const coordinates = document.getElementById("coordinates").value;
            const phone = document.getElementById("phone").value;
            const parsedCoordinates = parseCoordinates(coordinates);

            if (parsedCoordinates) {
                locations.push({ coordinates: parsedCoordinates, phone });
                document.getElementById("location-list").innerHTML += `
                    <div class="location">
                        <strong>Coordenadas:</strong> ${coordinates} <br>
                        <strong>Teléfono:</strong> ${phone}
                    </div>
                `;
                document.getElementById("coordinates").value = "";
                document.getElementById("phone").value = "";
            }
        });

        document.getElementById("calculate-route").addEventListener("click", () => {
            if (locations.length < 2) {
                alert("Debes agregar al menos dos ubicaciones.");
                return;
            }

            navigator.geolocation.getCurrentPosition((position) => {
                const userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                };

                const service = new google.maps.DistanceMatrixService();
                const destinations = locations.map((loc) => loc.coordinates);

                service.getDistanceMatrix(
                    {
                        origins: [userLocation],
                        destinations: destinations,
                        travelMode: "DRIVING",
                        unitSystem: google.maps.UnitSystem.METRIC,
                    },
                    (response, status) => {
                        if (status !== "OK") {
                            alert("Error al calcular distancias: " + status);
                            return;
                        }

                        const results = response.rows[0].elements;
                        locations = locations.map((loc, i) => ({
                            ...loc,
                            distance: results[i].distance.value, // distancia en metros
                        }));

                        // Ordenar por distancia
                        locations.sort((a, b) => a.distance - b.distance);

                        // Mostrar lista ordenada
                        const list = document.getElementById("location-list");
                        list.innerHTML = "";
                        locations.forEach((loc, index) => {
                            list.innerHTML += `
                                <div class="location">
                                    <strong>#${index + 1}</strong> <br>
                                    <strong>Coordenadas:</strong> ${loc.coordinates.lat}, ${loc.coordinates.lng} <br>
                                    <strong>Teléfono:</strong> ${loc.phone} <br>
                                    <strong>Distancia:</strong> ${(loc.distance / 1000).toFixed(2)} km <br>
                                    <button onclick="openInGoogleMaps(${loc.coordinates.lat}, ${loc.coordinates.lng})">Ver en Google Maps</button>
                                </div>
                            `;
                        });
                    }
                );
            });
        });

        function openInGoogleMaps(lat, lng) {
            window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lng}`);
        }
    </script>
</body>
</html>
