<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcular Distancias</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 600px;
            margin: auto;
            padding: 20px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container bg-white p-6 rounded shadow">
        <h1 class="text-2xl font-bold mb-4">Calcular Distancias con Google Maps</h1>

        <!-- Formulario para agregar ubicaciones -->
        <form id="location-form" class="mb-4">
            <input 
                type="text" 
                id="coordinates" 
                class="border p-2 w-full mb-2" 
                placeholder="Latitud, Longitud (ej. 19.432608, -99.133209 o 19°25'57.4\"N, 99°8'16.3\"W)" 
                required>
            <input 
                type="text" 
                id="phone" 
                class="border p-2 w-full mb-2" 
                placeholder="Número del cliente" 
                required>
            <button 
                type="submit" 
                class="bg-blue-500 text-white px-4 py-2 rounded">
                Agregar Ubicación
            </button>
        </form>

        <!-- Botón para calcular rutas -->
        <button 
            id="calculate-route" 
            class="bg-green-500 text-white px-4 py-2 rounded w-full mb-4">
            Calcular y Ordenar
        </button>

        <!-- Lista de ubicaciones -->
        <div id="location-list" class="space-y-4"></div>
    </div>

    <!-- Script de Google Maps con el atributo callback -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDIGXKfC3l8btI1dafKYXEITkTRqAA0xyU&libraries=places"
      async
      defer>
    </script>

    <script>
    function dmsToDecimal(dms) {
        // Convierte coordenadas en formato DMS (grados, minutos, segundos) a decimal
        const regex = /(\d+)[°º]?\s*(\d+)?['′]?\s*(\d+\.?\d*)?["″]?\s*([NSEW])/i;
        const match = dms.match(regex);
        if (!match) {
            alert("Formato de coordenadas incorrecto. Usa DMS o formato decimal.");
            return null;
        }

        let [_, degrees, minutes = 0, seconds = 0, direction] = match;
        let decimal = parseFloat(degrees) + parseFloat(minutes) / 60 + parseFloat(seconds) / 3600;

        if (["S", "W"].includes(direction.toUpperCase())) {
            decimal = -decimal;
        }

        return decimal;
    }

    function parseCoordinates(coordinates) {
        const [latDms, lngDms] = coordinates.split(",");
        const lat = dmsToDecimal(latDms.trim());
        return lat !== null && lng !== null ? { lat, lng } : null;
    }

    let userLocation = null;
    const locations = [];

    function getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    console.log("Ubicación del usuario:", userLocation);
                },
                (error) => {
                    alert("No se pudo obtener la ubicación. Asegúrate de permitir el acceso a la ubicación.");
                    console.error(error);
                }
            );
        } else {
            alert("Geolocalización no soportada en este navegador.");
        }
    }

    function calculateAndSortDistances() {
        if (!userLocation) {
            alert("Primero debemos obtener tu ubicación actual.");
            return;
        }

        const service = new google.maps.DistanceMatrixService();
        const origins = [userLocation];
        const destinations = locations.map(loc => loc.coordinates);

        service.getDistanceMatrix(
            {
                origins,
                destinations,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
            },
            (response, status) => {
                if (status !== "OK") {
                    alert("Error al calcular las distancias: " + status);
                    return;
                }

                const distances = response.rows[0].elements;
                distances.forEach((element, index) => {
                    locations[index].distance = element.distance.value; // Distancia en metros
                    locations[index].distanceText = element.distance.text; // Distancia legible
                });

                // Ordenar por distancia
                locations.sort((a, b) => a.distance - b.distance);

                // Mostrar resultados
                displayLocations();
            }
        );
    }

    function displayLocations() {
        const locationList = document.getElementById("location-list");
        locationList.innerHTML = "";

        locations.forEach((loc, index) => {
            locationList.innerHTML += `
                <div class="p-4 bg-gray-200 rounded">
                    <p><strong>${index + 1}. Coordenadas:</strong> ${loc.rawCoordinates}</p>
                    <p><strong>Teléfono:</strong> ${loc.phone}</p>
                    <p><strong>Distancia:</strong> ${loc.distanceText}</p>
                    <a 
                        href="https://www.google.com/maps/dir/?api=1&destination=${loc.coordinates.lat},${loc.coordinates.lng}" 
                        target="_blank" 
                        class="text-blue-500 underline">
                        Ver en Google Maps
                    </a>
                </div>`;
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        getUserLocation();

        const form = document.getElementById("location-form");
        form.addEventListener("submit", (event) => {
            event.preventDefault();
            const rawCoordinates = document.getElementById("coordinates").value;
            const phone = document.getElementById("phone").value;

            const parsedCoordinates = parseCoordinates(rawCoordinates);
            if (parsedCoordinates) {
                locations.push({
                    rawCoordinates,
                    phone,
                    coordinates: parsedCoordinates,
                });
                displayLocations();
                form.reset();
            }
        });

        const calculateRouteBtn = document.getElementById("calculate-route");
        calculateRouteBtn.addEventListener("click", calculateAndSortDistances);
    });
</script>

</body>
</html>
